<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GoGospel Listener</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .status {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .status.disconnected {
            background: rgba(255, 0, 0, 0.3);
        }
        .status.connected {
            background: rgba(0, 255, 0, 0.3);
        }
        .start-btn {
            display: block;
            width: 100%;
            padding: 20px;
            font-size: 1.5em;
            font-weight: bold;
            color: white;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .start-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        .start-btn:disabled {
            background: rgba(128, 128, 128, 0.5);
            cursor: not-allowed;
            transform: none;
        }
        .text-box {
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            min-height: 80px;
            font-size: 1.1em;
            line-height: 1.5;
            word-wrap: break-word;
        }
        .text-box h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: #ffd700;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }
        .audio-controls {
            text-align: center;
            margin-top: 20px;
        }
        audio {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
        }
        .timestamp {
            text-align: center;
            font-size: 0.9em;
            opacity: 0.7;
            margin-top: 10px;
        }
        @media (max-width: 480px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            h1 {
                font-size: 2em;
            }
            .start-btn {
                padding: 15px;
                font-size: 1.3em;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéß GoGospel Listener</h1>
        
        <div id="status" class="status disconnected">
            Disconnected - Tap Start Listening
        </div>
        
        <button id="startBtn" class="start-btn">
            üéµ Start Listening
        </button>
        
        <div class="text-box">
            <h3>üìù Original Text</h3>
            <div id="transcription">Waiting for audio...</div>
        </div>
        
        <div class="text-box">
            <h3>üåç Translation</h3>
            <div id="translation">Waiting for translation...</div>
        </div>
        
        <div class="audio-controls">
            <audio id="audioPlayer" controls preload="none">
                Your browser does not support audio playback.
            </audio>
        </div>
        
        <div class="timestamp" id="timestamp"></div>
    </div>

    <script>
        let ws = null;
        let isListening = false;
        let audioInitialized = false;
        let wakeLock = null;
        
        const statusEl = document.getElementById('status');
        const startBtn = document.getElementById('startBtn');
        const transcriptionEl = document.getElementById('transcription');
        const translationEl = document.getElementById('translation');
        const audioPlayer = document.getElementById('audioPlayer');
        const timestampEl = document.getElementById('timestamp');
        
        function updateStatus(message, isConnected) {
            statusEl.textContent = message;
            statusEl.className = `status ${isConnected ? 'connected' : 'disconnected'}`;
        }
        
        function formatTimestamp(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp * 1000);
            return `Last update: ${date.toLocaleTimeString()}`;
        }
        
        function updateContent(data) {
            console.log('Received update:', data);
            if (data.transcription) {
                transcriptionEl.textContent = data.transcription;
            }
            if (data.translation) {
                translationEl.textContent = data.translation;
            }
            if (data.audio_url && audioInitialized) {
                console.log('Updating audio URL:', data.audio_url);
                // Update audio source and try to play
                if (data.audio_url.startsWith('http')) {
                    audioPlayer.src = data.audio_url;
                } else {
                    const serverUrl = window.location.origin;
                    audioPlayer.src = serverUrl + data.audio_url;
                }
                audioPlayer.load(); // Force reload
                audioPlayer.play().catch(e => {
                    console.log('Auto-play failed:', e);
                });
            }
            if (data.timestamp) {
                timestampEl.textContent = formatTimestamp(data.timestamp);
            }
        }
        
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            
            ws = new WebSocket(wsUrl);
            
            ws.onopen = function() {
                updateStatus('Connected - Listening for updates', true);
                startBtn.textContent = 'üîä Listening...';
                startBtn.disabled = true;
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    updateContent(data);
                } catch (e) {
                    console.error('Error parsing WebSocket message:', e);
                }
            };
            
            ws.onclose = function() {
                updateStatus('Disconnected - Tap to reconnect', false);
                startBtn.textContent = 'üîÑ Reconnect';
                startBtn.disabled = false;
                isListening = false;
                
                // Auto-reconnect after 3 seconds
                setTimeout(() => {
                    if (!isListening) {
                        connectWebSocket();
                    }
                }, 3000);
            };
            
            ws.onerror = function(error) {
                console.error('WebSocket error:', error);
                updateStatus('Connection error - Check server', false);
            };
        }
        
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Screen wake lock acquired');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('Screen wake lock released');
                    });
                } else {
                    console.log('Wake Lock API not supported');
                }
            } catch (err) {
                console.error('Failed to acquire wake lock:', err);
            }
        }
        
        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
                console.log('Wake lock manually released');
            }
        }
        
        function initializeAudio() {
            // Initialize audio context on user gesture (required for mobile)
            if (!audioInitialized) {
                audioPlayer.load();
                audioInitialized = true;
                console.log('Audio initialized');
            }
        }
        
        startBtn.addEventListener('click', function() {
            if (!isListening) {
                initializeAudio();
                requestWakeLock(); // Prevent screen timeout
                connectWebSocket();
                isListening = true;
            }
        });
        
        // Fallback: Poll for updates if WebSocket fails
        function pollForUpdates() {
            if (ws && ws.readyState === WebSocket.OPEN) {
                return; // WebSocket is working
            }
            
            fetch('/latest')
                .then(response => response.json())
                .then(data => updateContent(data))
                .catch(e => console.log('Polling failed:', e));
        }
        
        // Poll every 2 seconds as fallback
        setInterval(pollForUpdates, 2000);
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                if (audioPlayer && !audioPlayer.paused) {
                    audioPlayer.pause();
                }
            } else {
                // Re-acquire wake lock when page becomes visible again
                if (isListening && !wakeLock) {
                    requestWakeLock();
                }
            }
        });
        
        // Handle wake lock release (e.g., when battery is low)
        if ('wakeLock' in navigator) {
            navigator.wakeLock.addEventListener('release', () => {
                // Try to re-acquire wake lock if still listening
                if (isListening) {
                    setTimeout(() => requestWakeLock(), 1000);
                }
            });
        }
        
        // Release wake lock when page is unloaded
        window.addEventListener('beforeunload', function() {
            releaseWakeLock();
        });
    </script>
</body>
</html>
